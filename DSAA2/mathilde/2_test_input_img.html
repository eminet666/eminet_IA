<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Test du Mod√®le ml5.js</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"></script>
    <script src="https://unpkg.com/ml5@latest/dist/ml5.min.js"></script>
</head>

<body>
    <h1>Test du mod√®le entra√Æn√©</h1>
    <input type="file" id="fileInput" />
    <br />
    <img id="preview" width="224" height="224" />
    <p id="result">R√©sultat : En attente...</p>

    <script>
        let nn; // Stocker le mod√®le ml5
        const imgElement = document.getElementById("preview");

        // Charger le mod√®le entra√Æn√©
        function loadModel() {
            nn = ml5.neuralNetwork({ task: 'classification' });
            nn.load(
                {
                    model: 'model.json',
                    metadata: 'model_meta.json',
                    weights: 'model.weights.bin'
                },
                modelLoaded
            );
        }

        function modelLoaded() {
            console.log("‚úÖ Mod√®le charg√© avec succ√®s !");
            document.getElementById("result").innerText = "Mod√®le pr√™t. Chargez une image.";
        }

        // D√©clencher l'√©v√©nement lorsqu'un fichier est charg√©
        document.getElementById("fileInput").addEventListener("change", function (event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    imgElement.src = e.target.result;
                    imgElement.onload = function () {
                        classifyImage(); // Une fois l'image charg√©e, tester la classification
                    };
                };
                reader.readAsDataURL(file);
            }
        });

        // Fonction pour classifier l'image
        function classifyImage() {
            // Cr√©er un canvas temporaire pour dessiner l'image
            const canvas = document.createElement('canvas');
            canvas.width = 224; // Largeur attendue par le mod√®le
            canvas.height = 224; // Hauteur attendue par le mod√®le
            const ctx = canvas.getContext('2d');
            ctx.drawImage(imgElement, 0, 0, 224, 224);

            // Obtenir les donn√©es de pixels de l'image
            const imageData = ctx.getImageData(0, 0, 224, 224);
            const data = imageData.data;

            // Convertir les donn√©es de pixels en un tableau de caract√©ristiques
            const inputs = [];
            for (let i = 0; i < data.length; i += 4) {
                // Convertir en niveaux de gris en utilisant la moyenne des composantes R, G et B
                const grayscale = (data[i] + data[i + 1] + data[i + 2]) / 3;
                // Normaliser la valeur entre 0 et 1
                inputs.push(grayscale / 255);
            }

            // Classer l'image en utilisant le mod√®le
            nn.classify({ inputs: inputs }, function (error, results) {
                if (error) {
                    console.error("Erreur :", error);
                    document.getElementById("result").innerText = "Erreur lors de la classification.";
                } else {
                    console.log("üîç R√©sultats :", results);
                    const label = results[0].label;
                    const confidence = (results[0].confidence * 100).toFixed(2);
                    document.getElementById("result").innerText = `Pr√©diction : ${label} (Confiance : ${confidence}%)`;
                }
            });
        }

        // Lancer le chargement du mod√®le
        loadModel();
    </script>
</body>

</html>